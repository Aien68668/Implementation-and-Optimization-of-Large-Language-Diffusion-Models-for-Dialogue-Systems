# LLaDAç³»ç»Ÿæµç¨‹å›¾

## ç³»ç»Ÿæ•´ä½“æ¶æ„æµç¨‹å›¾

```mermaid
graph TB
    %% ç”¨æˆ·å±‚
    User[ğŸ‘¤ ç”¨æˆ·] --> UI[ğŸ–¥ï¸ Reactå‰ç«¯ç•Œé¢]
    
    %% å‰ç«¯ç»„ä»¶å±‚
    UI --> Sidebar[ğŸ“‹ Sidebar<br/>å¯¹è¯ç®¡ç†]
    UI --> InputArea[âœï¸ InputArea<br/>æ¶ˆæ¯è¾“å…¥]
    UI --> SettingsPanel[âš™ï¸ SettingsPanel<br/>å‚æ•°è®¾ç½®]
    UI --> MessageList[ğŸ’¬ MessageList<br/>æ¶ˆæ¯æ˜¾ç¤º]
    UI --> ConfidenceIndicator[ğŸ¨ ConfidenceIndicator<br/>ç½®ä¿¡åº¦æŒ‡ç¤ºå™¨]
    
    %% APIæœåŠ¡å±‚
    InputArea --> APIService[ğŸ”— apiService.js<br/>HTTPå®¢æˆ·ç«¯]
    SettingsPanel --> APIService
    
    %% ç½‘ç»œä¼ è¾“
    APIService -->|HTTP POST /generate| FlaskAPI[ğŸŒ Flask API<br/>ç«¯å£9000]
    
    %% åç«¯å¤„ç†å±‚
    FlaskAPI --> RequestValidation[âœ… è¯·æ±‚éªŒè¯<br/>å‚æ•°æ£€æŸ¥]
    RequestValidation --> GenerateResponse[ğŸ§  generate_response<br/>ä¸»å¤„ç†å‡½æ•°]
    
    %% æ¨¡å‹æ¨ç†å±‚
    GenerateResponse --> ModelInit[ğŸ”§ æ¨¡å‹åˆå§‹åŒ–<br/>åºåˆ—å‡†å¤‡]
    ModelInit --> BlockProcessing[ğŸ“¦ Blockå¤„ç†<br/>å¹¶è¡Œåˆ†å—]
    
    %% æ‰©æ•£ç”Ÿæˆå¾ªç¯
    BlockProcessing --> DiffusionLoop{ğŸ”„ æ‰©æ•£å¾ªç¯<br/>32æ­¥è¿­ä»£}
    
    %% æ¯æ­¥å¤„ç†æµç¨‹
    DiffusionLoop --> ModelInference[ğŸ¤– LLaDAæ¨¡å‹æ¨ç†<br/>logitsè®¡ç®—]
    ModelInference --> NoiseAddition[ğŸ² Gumbelå™ªå£°æ³¨å…¥<br/>éšæœºæ€§æ§åˆ¶]
    NoiseAddition --> TokenPrediction[ğŸ¯ Tokené¢„æµ‹<br/>argmaxé€‰æ‹©]
    TokenPrediction --> ConfidenceCalc[ğŸ“Š ç½®ä¿¡åº¦è®¡ç®—<br/>softmaxæ¦‚ç‡]
    ConfidenceCalc --> TokenSelection[ğŸ” Tokené€‰æ‹©<br/>top-kç­›é€‰]
    TokenSelection --> ConstraintEnforce[ğŸ¯ çº¦æŸå¼ºåˆ¶æ‰§è¡Œ<br/>ä½ç½®è¯è¯­å›ºå®š]
    ConstraintEnforce --> VisualizationUpdate[ğŸ¨ å¯è§†åŒ–çŠ¶æ€æ›´æ–°<br/>é¢œè‰²ç¼–ç ]
    
    %% å¾ªç¯æ§åˆ¶
    VisualizationUpdate --> StepCheck{æ­¥éª¤æ£€æŸ¥}
    StepCheck -->|æœªå®Œæˆ| DiffusionLoop
    StepCheck -->|å®Œæˆ| BlockCheck{å—æ£€æŸ¥}
    BlockCheck -->|è¿˜æœ‰å—| BlockProcessing
    BlockCheck -->|å…¨éƒ¨å®Œæˆ| FinalProcessing[âœ¨ æœ€ç»ˆå¤„ç†<br/>æ–‡æœ¬è§£ç ]
    
    %% å“åº”æ„é€ 
    FinalProcessing --> ResponseConstruct[ğŸ“‹ å“åº”æ„é€ <br/>JSONæ ¼å¼åŒ–]
    ResponseConstruct --> FlaskResponse[ğŸ“¤ Flaskå“åº”<br/>HTTPè¿”å›]
    
    %% å‰ç«¯æ¥æ”¶
    FlaskResponse -->|HTTP Response| APIService
    APIService --> StateUpdate[ğŸ”„ çŠ¶æ€æ›´æ–°<br/>Reactç»„ä»¶]
    StateUpdate --> MessageList
    StateUpdate --> ConfidenceIndicator
    
    %% ç”¨æˆ·åé¦ˆ
    MessageList --> User
    ConfidenceIndicator --> User
    
    %% æ ·å¼å®šä¹‰
    classDef userClass fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef frontendClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef apiClass fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef backendClass fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef modelClass fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef processingClass fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    
    class User userClass
    class UI,Sidebar,InputArea,SettingsPanel,MessageList,ConfidenceIndicator frontendClass
    class APIService,FlaskAPI apiClass
    class RequestValidation,GenerateResponse,ResponseConstruct,FlaskResponse backendClass
    class ModelInit,ModelInference,NoiseAddition,TokenPrediction modelClass
    class BlockProcessing,DiffusionLoop,ConfidenceCalc,TokenSelection,ConstraintEnforce,VisualizationUpdate,FinalProcessing processingClass
```

## è¯¦ç»†æ•°æ®æµè½¬å›¾

```mermaid
sequenceDiagram
    participant User as ğŸ‘¤ ç”¨æˆ·
    participant UI as ğŸ–¥ï¸ å‰ç«¯ç•Œé¢
    participant API as ğŸ”— APIæœåŠ¡
    participant Backend as ğŸŒ åç«¯æœåŠ¡
    participant Model as ğŸ¤– LLaDAæ¨¡å‹
    participant GPU as ğŸ® GPUè®¾å¤‡
    
    User->>UI: è¾“å…¥æ¶ˆæ¯ "ä½ å¥½"
    User->>UI: è®¾ç½®å‚æ•° {temperature: 0.8, steps: 32}
    User->>UI: è®¾ç½®çº¦æŸ "5:ä¸–ç•Œ"
    UI->>UI: æ”¶é›†è¡¨å•æ•°æ®
    
    UI->>API: sendMessage(messages, settings)
    API->>API: æ·»åŠ è¯·æ±‚IDå’Œæ—¶é—´æˆ³
    API->>Backend: POST /generate
    
    Note over Backend: è¯·æ±‚éªŒè¯å’Œæ—¥å¿—è®°å½•
    Backend->>Backend: è§£æå‚æ•°å’Œçº¦æŸ
    Backend->>Backend: åˆå§‹åŒ–åºåˆ— [prompt][MASK][MASK]...
    Backend->>Backend: åº”ç”¨åˆå§‹çº¦æŸ
    
    loop æ¯ä¸ªBlock (å¹¶è¡Œå¤„ç†)
        loop æ¯ä¸ªæ‰©æ•£æ­¥éª¤ (32æ­¥)
            Backend->>Model: è¾“å…¥å½“å‰åºåˆ—
            Model->>GPU: å‰å‘æ¨ç†è®¡ç®—
            GPU-->>Model: è¿”å›logits
            Model-->>Backend: é¢„æµ‹ç»“æœ
            
            Backend->>Backend: æ·»åŠ Gumbelå™ªå£°
            Backend->>Backend: è®¡ç®—ç½®ä¿¡åº¦
            Backend->>Backend: é€‰æ‹©é«˜ç½®ä¿¡åº¦tokens
            Backend->>Backend: å¼ºåˆ¶æ‰§è¡Œçº¦æŸ
            Backend->>Backend: æ›´æ–°å¯è§†åŒ–çŠ¶æ€
            
            Note over Backend: è®°å½•å½“å‰æ­¥éª¤:<br/>tokens + é¢œè‰²ç¼–ç 
        end
    end
    
    Backend->>Backend: è§£ç æœ€ç»ˆæ–‡æœ¬
    Backend->>Backend: æ„é€ å“åº”JSON
    Backend-->>API: è¿”å› {response, visualization, duration}
    
    API->>API: è®°å½•å“åº”æ—¥å¿—
    API-->>UI: è¿”å›æ•°æ®
    
    UI->>UI: æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
    UI->>UI: æ’­æ”¾tokenåŠ¨ç”»
    UI->>UI: æ˜¾ç¤ºç½®ä¿¡åº¦é¢œè‰²
    UI-->>User: å±•ç¤ºç”Ÿæˆç»“æœ
```

## æ ¸å¿ƒç®—æ³•æµç¨‹å›¾

```mermaid
flowchart TD
    Start([å¼€å§‹ç”Ÿæˆ]) --> Init[åˆå§‹åŒ–åºåˆ—<br/>[prompt + MASK...]]
    Init --> ParseConstraints[è§£æçº¦æŸ<br/>ä½ç½®:è¯è¯­]
    ParseConstraints --> ApplyConstraints[åº”ç”¨åˆå§‹çº¦æŸ]
    ApplyConstraints --> BlockDivision[åˆ’åˆ†å¤„ç†å—<br/>block_length]
    
    BlockDivision --> BlockLoop{éå†æ¯ä¸ªå—}
    BlockLoop --> StepLoop{æ‰©æ•£æ­¥éª¤å¾ªç¯<br/>1 to steps}
    
    StepLoop --> ModelForward[æ¨¡å‹å‰å‘æ¨ç†<br/>LLaDA(sequence)]
    ModelForward --> CFGCheck{CFGå¼•å¯¼?<br/>cfg_scale > 0}
    
    CFGCheck -->|æ˜¯| CFGProcess[åˆ†ç±»å™¨è‡ªç”±å¼•å¯¼<br/>æ¡ä»¶+æ— æ¡ä»¶é¢„æµ‹]
    CFGCheck -->|å¦| DirectLogits[ç›´æ¥ä½¿ç”¨logits]
    CFGProcess --> NoiseInjection
    DirectLogits --> NoiseInjection[æ³¨å…¥Gumbelå™ªå£°<br/>temperatureæ§åˆ¶]
    
    NoiseInjection --> TokenPredict[Tokené¢„æµ‹<br/>argmax selection]
    TokenPredict --> ConfidenceCalc[ç½®ä¿¡åº¦è®¡ç®—<br/>softmaxæ¦‚ç‡]
    
    ConfidenceCalc --> RemaskStrategy{é‡æ©ç ç­–ç•¥}
    RemaskStrategy -->|low_confidence| ConfidenceGuided[åŸºäºç½®ä¿¡åº¦é€‰æ‹©]
    RemaskStrategy -->|random| RandomSelection[éšæœºé€‰æ‹©]
    
    ConfidenceGuided --> TopKSelect[Top-Ké€‰æ‹©<br/>ä¿ç•™é«˜ç½®ä¿¡åº¦]
    RandomSelection --> TopKSelect
    
    TopKSelect --> UpdateSequence[æ›´æ–°åºåˆ—<br/>æ›¿æ¢é€‰ä¸­tokens]
    UpdateSequence --> ForceConstraints[å¼ºåˆ¶æ‰§è¡Œçº¦æŸ<br/>è¦†ç›–é¢„æµ‹]
    ForceConstraints --> ColorMapping[é¢œè‰²æ˜ å°„<br/>ç½®ä¿¡åº¦å¯è§†åŒ–]
    
    ColorMapping --> VisualizationRecord[è®°å½•å¯è§†åŒ–çŠ¶æ€<br/>[token, color]]
    VisualizationRecord --> MemoryCleanup[GPUå†…å­˜æ¸…ç†<br/>torch.cuda.empty_cache]
    
    MemoryCleanup --> StepComplete{æ­¥éª¤å®Œæˆ?}
    StepComplete -->|å¦| StepLoop
    StepComplete -->|æ˜¯| BlockComplete{å—å®Œæˆ?}
    
    BlockComplete -->|å¦| BlockLoop
    BlockComplete -->|æ˜¯| DecodeText[è§£ç æœ€ç»ˆæ–‡æœ¬<br/>tokenizer.decode]
    
    DecodeText --> ResponseFormat[æ ¼å¼åŒ–å“åº”<br/>JSONæ„é€ ]
    ResponseFormat --> End([è¿”å›ç»“æœ])
    
    %% æ ·å¼å®šä¹‰
    classDef initClass fill:#e3f2fd,stroke:#1976d2
    classDef processClass fill:#f3e5f5,stroke:#7b1fa2
    classDef modelClass fill:#fff3e0,stroke:#f57c00
    classDef decisionClass fill:#e8f5e8,stroke:#388e3c
    classDef outputClass fill:#fce4ec,stroke:#c2185b
    
    class Start,Init,ParseConstraints,ApplyConstraints,BlockDivision initClass
    class ModelForward,CFGProcess,NoiseInjection,TokenPredict,ConfidenceCalc,TopKSelect,UpdateSequence,ForceConstraints,ColorMapping,VisualizationRecord,MemoryCleanup processClass
    class CFGCheck,RemaskStrategy,StepComplete,BlockComplete decisionClass
    class DecodeText,ResponseFormat,End outputClass
```

## ç½®ä¿¡åº¦é¢œè‰²ç¼–ç æµç¨‹

```mermaid
flowchart LR
    TokenGenerated[Tokenç”Ÿæˆ] --> ConfidenceCalc[è®¡ç®—ç½®ä¿¡åº¦<br/>softmaxæ¦‚ç‡]
    ConfidenceCalc --> ConfidenceValue{ç½®ä¿¡åº¦å€¼}
    
    ConfidenceValue -->|< 0.3| LowConf[ä½ç½®ä¿¡åº¦<br/>çº¢è‰² #FF6666]
    ConfidenceValue -->|0.3-0.7| MedConf[ä¸­ç­‰ç½®ä¿¡åº¦<br/>æ©™è‰² #FFAA33]
    ConfidenceValue -->|> 0.7| HighConf[é«˜ç½®ä¿¡åº¦<br/>ç»¿è‰² #66CC66]
    
    LowConf --> StatusCheck{TokençŠ¶æ€}
    MedConf --> StatusCheck
    HighConf --> StatusCheck
    
    StatusCheck -->|æ–°ç”Ÿæˆ| ApplyColor[åº”ç”¨ç½®ä¿¡åº¦é¢œè‰²]
    StatusCheck -->|çº¦æŸå›ºå®š| ConstraintColor[è“è‰² #6699CC]
    StatusCheck -->|æ©ç çŠ¶æ€| MaskColor[ç°è‰² #444444]
    
    ApplyColor --> Display[å‰ç«¯æ˜¾ç¤º]
    ConstraintColor --> Display
    MaskColor --> Display
    
    Display --> Animation[Tokenå‡ºç°åŠ¨ç”»]
    Animation --> UserFeedback[ç”¨æˆ·è§†è§‰åé¦ˆ]
```

## é”™è¯¯å¤„ç†æµç¨‹å›¾

```mermaid
flowchart TD
    Request[ç”¨æˆ·è¯·æ±‚] --> Validation{å‚æ•°éªŒè¯}
    Validation -->|å¤±è´¥| ValidationError[400 å‚æ•°é”™è¯¯]
    Validation -->|æˆåŠŸ| ModelLoading{æ¨¡å‹åŠ è½½}
    
    ModelLoading -->|å¤±è´¥| ModelError[500 æ¨¡å‹é”™è¯¯]
    ModelLoading -->|æˆåŠŸ| Generation{ç”Ÿæˆè¿‡ç¨‹}
    
    Generation -->|CUDA OOM| MemoryError[GPUå†…å­˜ä¸è¶³]
    Generation -->|å…¶ä»–å¼‚å¸¸| UnknownError[æœªçŸ¥é”™è¯¯]
    Generation -->|æˆåŠŸ| Success[200 æˆåŠŸå“åº”]
    
    ValidationError --> ErrorLog[è®°å½•é”™è¯¯æ—¥å¿—]
    ModelError --> ErrorLog
    MemoryError --> MemoryCleanup[æ¸…ç†GPUå†…å­˜]
    MemoryCleanup --> ErrorLog
    UnknownError --> ErrorLog
    
    ErrorLog --> ErrorResponse[è¿”å›é”™è¯¯å“åº”<br/>å«é”™è¯¯ç±»å‹å’Œæ¶ˆæ¯]
    ErrorResponse --> FrontendHandle[å‰ç«¯é”™è¯¯å¤„ç†]
    FrontendHandle --> UserNotification[ç”¨æˆ·å‹å¥½æç¤º]
    
    Success --> LogSuccess[è®°å½•æˆåŠŸæ—¥å¿—]
    LogSuccess --> FrontendRender[å‰ç«¯æ¸²æŸ“ç»“æœ]
    FrontendRender --> UserDisplay[ç”¨æˆ·æŸ¥çœ‹ç»“æœ]
```

è¿™äº›Mermaidæµç¨‹å›¾å…¨é¢å±•ç¤ºäº†LLaDAç³»ç»Ÿçš„ï¼š

1. **æ•´ä½“æ¶æ„æµç¨‹** - ä»ç”¨æˆ·ç•Œé¢åˆ°åç«¯æ¨¡å‹çš„å®Œæ•´æ•°æ®æµ
2. **è¯¦ç»†äº¤äº’åºåˆ—** - æ—¶åºå›¾æ˜¾ç¤ºå„ç»„ä»¶é—´çš„å…·ä½“äº¤äº’
3. **æ ¸å¿ƒç®—æ³•æµç¨‹** - æ‰©æ•£ç”Ÿæˆçš„è¯¦ç»†æ­¥éª¤
4. **ç½®ä¿¡åº¦å¤„ç†** - é¢œè‰²ç¼–ç çš„é€»è¾‘
5. **é”™è¯¯å¤„ç†æœºåˆ¶** - å¼‚å¸¸æƒ…å†µçš„å¤„ç†æµç¨‹

ä½ å¯ä»¥å°†è¿™äº›å›¾è¡¨å¤åˆ¶åˆ°æ”¯æŒMermaidçš„ç¯å¢ƒä¸­ï¼ˆå¦‚GitHubã€Notionã€æˆ–åœ¨çº¿Mermaidç¼–è¾‘å™¨ï¼‰æ¥æŸ¥çœ‹å¯è§†åŒ–æ•ˆæœã€‚
