# LLaDA系统流程图

## 系统整体架构流程图

```mermaid
graph TB
    %% 用户层
    User[👤 用户] --> UI[🖥️ React前端界面]
    
    %% 前端组件层
    UI --> Sidebar[📋 Sidebar<br/>对话管理]
    UI --> InputArea[✏️ InputArea<br/>消息输入]
    UI --> SettingsPanel[⚙️ SettingsPanel<br/>参数设置]
    UI --> MessageList[💬 MessageList<br/>消息显示]
    UI --> ConfidenceIndicator[🎨 ConfidenceIndicator<br/>置信度指示器]
    
    %% API服务层
    InputArea --> APIService[🔗 apiService.js<br/>HTTP客户端]
    SettingsPanel --> APIService
    
    %% 网络传输
    APIService -->|HTTP POST /generate| FlaskAPI[🌐 Flask API<br/>端口9000]
    
    %% 后端处理层
    FlaskAPI --> RequestValidation[✅ 请求验证<br/>参数检查]
    RequestValidation --> GenerateResponse[🧠 generate_response<br/>主处理函数]
    
    %% 模型推理层
    GenerateResponse --> ModelInit[🔧 模型初始化<br/>序列准备]
    ModelInit --> BlockProcessing[📦 Block处理<br/>并行分块]
    
    %% 扩散生成循环
    BlockProcessing --> DiffusionLoop{🔄 扩散循环<br/>32步迭代}
    
    %% 每步处理流程
    DiffusionLoop --> ModelInference[🤖 LLaDA模型推理<br/>logits计算]
    ModelInference --> NoiseAddition[🎲 Gumbel噪声注入<br/>随机性控制]
    NoiseAddition --> TokenPrediction[🎯 Token预测<br/>argmax选择]
    TokenPrediction --> ConfidenceCalc[📊 置信度计算<br/>softmax概率]
    ConfidenceCalc --> TokenSelection[🔝 Token选择<br/>top-k筛选]
    TokenSelection --> ConstraintEnforce[🎯 约束强制执行<br/>位置词语固定]
    ConstraintEnforce --> VisualizationUpdate[🎨 可视化状态更新<br/>颜色编码]
    
    %% 循环控制
    VisualizationUpdate --> StepCheck{步骤检查}
    StepCheck -->|未完成| DiffusionLoop
    StepCheck -->|完成| BlockCheck{块检查}
    BlockCheck -->|还有块| BlockProcessing
    BlockCheck -->|全部完成| FinalProcessing[✨ 最终处理<br/>文本解码]
    
    %% 响应构造
    FinalProcessing --> ResponseConstruct[📋 响应构造<br/>JSON格式化]
    ResponseConstruct --> FlaskResponse[📤 Flask响应<br/>HTTP返回]
    
    %% 前端接收
    FlaskResponse -->|HTTP Response| APIService
    APIService --> StateUpdate[🔄 状态更新<br/>React组件]
    StateUpdate --> MessageList
    StateUpdate --> ConfidenceIndicator
    
    %% 用户反馈
    MessageList --> User
    ConfidenceIndicator --> User
    
    %% 样式定义
    classDef userClass fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef frontendClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef apiClass fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef backendClass fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef modelClass fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef processingClass fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    
    class User userClass
    class UI,Sidebar,InputArea,SettingsPanel,MessageList,ConfidenceIndicator frontendClass
    class APIService,FlaskAPI apiClass
    class RequestValidation,GenerateResponse,ResponseConstruct,FlaskResponse backendClass
    class ModelInit,ModelInference,NoiseAddition,TokenPrediction modelClass
    class BlockProcessing,DiffusionLoop,ConfidenceCalc,TokenSelection,ConstraintEnforce,VisualizationUpdate,FinalProcessing processingClass
```

## 详细数据流转图

```mermaid
sequenceDiagram
    participant User as 👤 用户
    participant UI as 🖥️ 前端界面
    participant API as 🔗 API服务
    participant Backend as 🌐 后端服务
    participant Model as 🤖 LLaDA模型
    participant GPU as 🎮 GPU设备
    
    User->>UI: 输入消息 "你好"
    User->>UI: 设置参数 {temperature: 0.8, steps: 32}
    User->>UI: 设置约束 "5:世界"
    UI->>UI: 收集表单数据
    
    UI->>API: sendMessage(messages, settings)
    API->>API: 添加请求ID和时间戳
    API->>Backend: POST /generate
    
    Note over Backend: 请求验证和日志记录
    Backend->>Backend: 解析参数和约束
    Backend->>Backend: 初始化序列 [prompt][MASK][MASK]...
    Backend->>Backend: 应用初始约束
    
    loop 每个Block (并行处理)
        loop 每个扩散步骤 (32步)
            Backend->>Model: 输入当前序列
            Model->>GPU: 前向推理计算
            GPU-->>Model: 返回logits
            Model-->>Backend: 预测结果
            
            Backend->>Backend: 添加Gumbel噪声
            Backend->>Backend: 计算置信度
            Backend->>Backend: 选择高置信度tokens
            Backend->>Backend: 强制执行约束
            Backend->>Backend: 更新可视化状态
            
            Note over Backend: 记录当前步骤:<br/>tokens + 颜色编码
        end
    end
    
    Backend->>Backend: 解码最终文本
    Backend->>Backend: 构造响应JSON
    Backend-->>API: 返回 {response, visualization, duration}
    
    API->>API: 记录响应日志
    API-->>UI: 返回数据
    
    UI->>UI: 更新消息列表
    UI->>UI: 播放token动画
    UI->>UI: 显示置信度颜色
    UI-->>User: 展示生成结果
```

## 核心算法流程图

```mermaid
flowchart TD
    Start([开始生成]) --> Init[初始化序列<br/>[prompt + MASK...]]
    Init --> ParseConstraints[解析约束<br/>位置:词语]
    ParseConstraints --> ApplyConstraints[应用初始约束]
    ApplyConstraints --> BlockDivision[划分处理块<br/>block_length]
    
    BlockDivision --> BlockLoop{遍历每个块}
    BlockLoop --> StepLoop{扩散步骤循环<br/>1 to steps}
    
    StepLoop --> ModelForward[模型前向推理<br/>LLaDA(sequence)]
    ModelForward --> CFGCheck{CFG引导?<br/>cfg_scale > 0}
    
    CFGCheck -->|是| CFGProcess[分类器自由引导<br/>条件+无条件预测]
    CFGCheck -->|否| DirectLogits[直接使用logits]
    CFGProcess --> NoiseInjection
    DirectLogits --> NoiseInjection[注入Gumbel噪声<br/>temperature控制]
    
    NoiseInjection --> TokenPredict[Token预测<br/>argmax selection]
    TokenPredict --> ConfidenceCalc[置信度计算<br/>softmax概率]
    
    ConfidenceCalc --> RemaskStrategy{重掩码策略}
    RemaskStrategy -->|low_confidence| ConfidenceGuided[基于置信度选择]
    RemaskStrategy -->|random| RandomSelection[随机选择]
    
    ConfidenceGuided --> TopKSelect[Top-K选择<br/>保留高置信度]
    RandomSelection --> TopKSelect
    
    TopKSelect --> UpdateSequence[更新序列<br/>替换选中tokens]
    UpdateSequence --> ForceConstraints[强制执行约束<br/>覆盖预测]
    ForceConstraints --> ColorMapping[颜色映射<br/>置信度可视化]
    
    ColorMapping --> VisualizationRecord[记录可视化状态<br/>[token, color]]
    VisualizationRecord --> MemoryCleanup[GPU内存清理<br/>torch.cuda.empty_cache]
    
    MemoryCleanup --> StepComplete{步骤完成?}
    StepComplete -->|否| StepLoop
    StepComplete -->|是| BlockComplete{块完成?}
    
    BlockComplete -->|否| BlockLoop
    BlockComplete -->|是| DecodeText[解码最终文本<br/>tokenizer.decode]
    
    DecodeText --> ResponseFormat[格式化响应<br/>JSON构造]
    ResponseFormat --> End([返回结果])
    
    %% 样式定义
    classDef initClass fill:#e3f2fd,stroke:#1976d2
    classDef processClass fill:#f3e5f5,stroke:#7b1fa2
    classDef modelClass fill:#fff3e0,stroke:#f57c00
    classDef decisionClass fill:#e8f5e8,stroke:#388e3c
    classDef outputClass fill:#fce4ec,stroke:#c2185b
    
    class Start,Init,ParseConstraints,ApplyConstraints,BlockDivision initClass
    class ModelForward,CFGProcess,NoiseInjection,TokenPredict,ConfidenceCalc,TopKSelect,UpdateSequence,ForceConstraints,ColorMapping,VisualizationRecord,MemoryCleanup processClass
    class CFGCheck,RemaskStrategy,StepComplete,BlockComplete decisionClass
    class DecodeText,ResponseFormat,End outputClass
```

## 置信度颜色编码流程

```mermaid
flowchart LR
    TokenGenerated[Token生成] --> ConfidenceCalc[计算置信度<br/>softmax概率]
    ConfidenceCalc --> ConfidenceValue{置信度值}
    
    ConfidenceValue -->|< 0.3| LowConf[低置信度<br/>红色 #FF6666]
    ConfidenceValue -->|0.3-0.7| MedConf[中等置信度<br/>橙色 #FFAA33]
    ConfidenceValue -->|> 0.7| HighConf[高置信度<br/>绿色 #66CC66]
    
    LowConf --> StatusCheck{Token状态}
    MedConf --> StatusCheck
    HighConf --> StatusCheck
    
    StatusCheck -->|新生成| ApplyColor[应用置信度颜色]
    StatusCheck -->|约束固定| ConstraintColor[蓝色 #6699CC]
    StatusCheck -->|掩码状态| MaskColor[灰色 #444444]
    
    ApplyColor --> Display[前端显示]
    ConstraintColor --> Display
    MaskColor --> Display
    
    Display --> Animation[Token出现动画]
    Animation --> UserFeedback[用户视觉反馈]
```

## 错误处理流程图

```mermaid
flowchart TD
    Request[用户请求] --> Validation{参数验证}
    Validation -->|失败| ValidationError[400 参数错误]
    Validation -->|成功| ModelLoading{模型加载}
    
    ModelLoading -->|失败| ModelError[500 模型错误]
    ModelLoading -->|成功| Generation{生成过程}
    
    Generation -->|CUDA OOM| MemoryError[GPU内存不足]
    Generation -->|其他异常| UnknownError[未知错误]
    Generation -->|成功| Success[200 成功响应]
    
    ValidationError --> ErrorLog[记录错误日志]
    ModelError --> ErrorLog
    MemoryError --> MemoryCleanup[清理GPU内存]
    MemoryCleanup --> ErrorLog
    UnknownError --> ErrorLog
    
    ErrorLog --> ErrorResponse[返回错误响应<br/>含错误类型和消息]
    ErrorResponse --> FrontendHandle[前端错误处理]
    FrontendHandle --> UserNotification[用户友好提示]
    
    Success --> LogSuccess[记录成功日志]
    LogSuccess --> FrontendRender[前端渲染结果]
    FrontendRender --> UserDisplay[用户查看结果]
```

这些Mermaid流程图全面展示了LLaDA系统的：

1. **整体架构流程** - 从用户界面到后端模型的完整数据流
2. **详细交互序列** - 时序图显示各组件间的具体交互
3. **核心算法流程** - 扩散生成的详细步骤
4. **置信度处理** - 颜色编码的逻辑
5. **错误处理机制** - 异常情况的处理流程

你可以将这些图表复制到支持Mermaid的环境中（如GitHub、Notion、或在线Mermaid编辑器）来查看可视化效果。
