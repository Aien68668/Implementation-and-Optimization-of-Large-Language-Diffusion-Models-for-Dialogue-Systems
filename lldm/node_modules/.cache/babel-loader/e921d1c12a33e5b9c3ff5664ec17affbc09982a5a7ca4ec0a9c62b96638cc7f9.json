{"ast":null,"code":"var _jsxFileName = \"/root/LLaDA-main/lldm/src/DiffusionModel.js\",\n  _s = $RefreshSig$();\nimport React, { useState, useEffect, useRef } from 'react';\nimport { sendMessage, getStatus, generateText, checkServerStatus, logger } from './services/apiService';\nimport ConfidenceIndicator from './components/ConfidenceIndicator';\nimport MessageList from './components/MessageList';\nimport SettingsPanel from './components/SettingsPanel';\nimport InputArea from './components/InputArea';\nimport Sidebar from './components/Sidebar';\nimport './styles/Sidebar.css';\nimport './styles/DiffusionModel.css';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst DiffusionModel = () => {\n  _s();\n  const [messages, setMessages] = useState([]);\n  const [input, setInput] = useState('');\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [chatHistory, setChatHistory] = useState([]);\n  const [constraints, setConstraints] = useState('');\n  const [serverError, setServerError] = useState(null);\n  const [confidence, setConfidence] = useState(0);\n  const [isWaitingForResponse, setIsWaitingForResponse] = useState(false);\n  const [settings, setSettings] = useState({\n    temperature: 0.0,\n    top_p: 0.95,\n    gen_length: 50,\n    num_beams: 4,\n    steps: 32,\n    cfg_scale: 1.0\n  });\n\n  // --- Conversation Management State ---\n  const [conversations, setConversations] = useState([{\n    id: 0,\n    name: '对话 1',\n    history: []\n  }]);\n  const [currentConversationId, setCurrentConversationId] = useState(0);\n  const [systemStatus, setSystemStatus] = useState({\n    backendConnected: false,\n    device: 'Unknown',\n    modelLoaded: false,\n    lastCheck: null\n  });\n  const messagesEndRef = useRef(null);\n  useEffect(() => {\n    var _messagesEndRef$curre;\n    (_messagesEndRef$curre = messagesEndRef.current) === null || _messagesEndRef$curre === void 0 ? void 0 : _messagesEndRef$curre.scrollIntoView({\n      behavior: \"smooth\"\n    });\n  }, [messages]);\n\n  // --- Conversation Management Handlers ---\n\n  const handleNewConversation = () => {\n    // Save the current conversation's history first.\n    const updatedConversations = conversations.map(conv => conv.id === currentConversationId ? {\n      ...conv,\n      history: messages\n    } : conv);\n\n    // Create the new conversation.\n    const newConversationId = Date.now(); // Use timestamp for unique ID\n    const newConversation = {\n      id: newConversationId,\n      name: `对话 ${updatedConversations.length + 1}`,\n      history: []\n    };\n    setConversations([...updatedConversations, newConversation]);\n    setCurrentConversationId(newConversationId);\n    setMessages([]); // Clear messages for the new conversation\n    setInput('');\n    setConfidence(0);\n    setIsWaitingForResponse(false);\n  };\n  const handleSwitchConversation = id => {\n    if (id === currentConversationId) return;\n\n    // Save the current conversation's history before switching.\n    const updatedConversations = conversations.map(conv => conv.id === currentConversationId ? {\n      ...conv,\n      history: messages\n    } : conv);\n    const newCurrentConversation = updatedConversations.find(conv => conv.id === id);\n    if (newCurrentConversation) {\n      setConversations(updatedConversations);\n      setCurrentConversationId(newCurrentConversation.id);\n      setMessages(newCurrentConversation.history || []);\n    }\n  };\n  const handleDeleteConversation = id => {\n    const updatedConversations = conversations.filter(conv => conv.id !== id);\n    setConversations(updatedConversations);\n    if (id === currentConversationId) {\n      if (updatedConversations.length > 0) {\n        const firstConv = updatedConversations[0];\n        setCurrentConversationId(firstConv.id);\n        setMessages(firstConv.history || []);\n      } else {\n        // If all conversations are deleted, create a new default one.\n        const newId = Date.now();\n        const newConv = {\n          id: newId,\n          name: '对话 1',\n          history: []\n        };\n        setConversations([newConv]);\n        setCurrentConversationId(newId);\n        setMessages([]);\n      }\n    }\n  };\n\n  // 生成完整的回复\n  const generateResponse = async userMessage => {\n    setIsGenerating(true);\n    setServerError(null);\n    try {\n      // 添加用户消息\n      const userMsg = {\n        id: Date.now(),\n        text: userMessage,\n        sender: 'user',\n        timestamp: new Date(),\n        isGenerated: true\n      };\n      setMessages(prev => [...prev, userMsg]);\n\n      // 准备聊天历史\n      const newChatHistory = [...chatHistory, {\n        role: 'user',\n        content: userMessage\n      }];\n\n      // 创建初始的掩码消息\n      const initialTokens = Array(settings.gen_length).fill(null).map((_, index) => ({\n        id: index,\n        char: '[MASK]',\n        confidence: 0,\n        color: '#444444',\n        isGenerated: false\n      }));\n      const botMessage = {\n        id: Date.now() + 1,\n        text: '',\n        sender: 'bot',\n        timestamp: new Date(),\n        tokens: initialTokens,\n        isGenerated: false\n      };\n      setMessages(prev => [...prev, botMessage]);\n\n      // 调用后端API生成响应\n      const requestSettings = {\n        ...settings,\n        constraints: constraints\n      };\n      const response = await sendMessage(newChatHistory, requestSettings);\n      if (response.error) {\n        throw new Error(response.error);\n      }\n\n      // 更新聊天历史\n      setChatHistory([...newChatHistory, {\n        role: 'assistant',\n        content: response.response\n      }]);\n\n      // 逐步显示可视化过程\n      const visualizationSteps = response.visualization || [];\n      for (let stepIndex = 0; stepIndex < visualizationSteps.length; stepIndex++) {\n        const step = visualizationSteps[stepIndex];\n        const tokens = parseVisualizationState(step);\n\n        // 更新消息中的tokens\n        setMessages(prev => prev.map(msg => {\n          if (msg.id === botMessage.id) {\n            return {\n              ...msg,\n              tokens\n            };\n          }\n          return msg;\n        }));\n\n        // 如果不是最后一步，等待一段时间再显示下一步\n        if (stepIndex < visualizationSteps.length - 1) {\n          await new Promise(resolve => setTimeout(resolve, 300));\n        }\n      }\n\n      // 生成完成，设置最终文本\n      setMessages(prev => {\n        const updatedMessages = prev.map(msg => {\n          if (msg.id === botMessage.id) {\n            return {\n              ...msg,\n              text: response.response,\n              isGenerated: true\n            };\n          }\n          return msg;\n        });\n\n        // 更新当前对话\n        const finalChatHistory = [...newChatHistory, {\n          role: 'assistant',\n          content: response.response\n        }];\n        setChatHistory(finalChatHistory);\n        updateCurrentConversation(updatedMessages, finalChatHistory);\n        return updatedMessages;\n      });\n    } catch (error) {\n      console.error('生成响应时出错:', error);\n      setServerError(error.message || '服务器连接失败');\n\n      // 移除未完成的bot消息\n      setMessages(prev => prev.filter(msg => msg.id !== Date.now() + 1));\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n  const handleSend = async () => {\n    if (input.trim() === '' || isWaitingForResponse) return;\n    const requestStartTime = Date.now();\n    const requestId = `frontend_${requestStartTime}_${Math.random().toString(36).substr(2, 9)}`;\n    logger.info(`[${requestId}] 开始处理用户发送请求`, {\n      userInput: input,\n      inputLength: input.length,\n      conversationId: currentConversationId,\n      currentMessagesCount: messages.length,\n      settings: settings,\n      constraints: constraints\n    });\n    const userMessage = {\n      id: Date.now(),\n      text: input,\n      sender: 'user',\n      timestamp: new Date()\n    };\n    setMessages(prevMessages => [...prevMessages, userMessage]);\n    const userInput = input;\n    setInput('');\n    setIsWaitingForResponse(true);\n    setIsGenerating(true);\n    setServerError(null);\n    try {\n      var _response$response, _response$visualizati;\n      // 准备聊天历史\n      const newChatHistory = [...chatHistory, {\n        role: 'user',\n        content: userInput\n      }];\n      logger.info(`[${requestId}] 准备发送到后端`, {\n        chatHistoryLength: newChatHistory.length,\n        lastUserMessage: userInput,\n        settingsUsed: settings\n      });\n\n      // 创建初始的掩码消息\n      const initialTokens = Array(settings.gen_length).fill(null).map((_, index) => ({\n        id: index,\n        char: '[MASK]',\n        confidence: 0,\n        color: '#444444',\n        isGenerated: false\n      }));\n      const botMessage = {\n        id: Date.now() + 1,\n        text: '',\n        sender: 'bot',\n        timestamp: new Date(),\n        tokens: initialTokens,\n        isGenerated: false\n      };\n      setMessages(prevMessages => [...prevMessages, botMessage]);\n\n      // 调用后端API生成响应\n      const requestSettings = {\n        ...settings,\n        constraints: constraints\n      };\n      logger.info(`[${requestId}] 发送API请求`, {\n        endpoint: '/generate',\n        messageCount: newChatHistory.length,\n        settings: requestSettings\n      });\n      const response = await sendMessage(newChatHistory, requestSettings);\n      if (response.error) {\n        throw new Error(response.error);\n      }\n      logger.info(`[${requestId}] 收到后端响应`, {\n        responseLength: (_response$response = response.response) === null || _response$response === void 0 ? void 0 : _response$response.length,\n        visualizationStepsCount: (_response$visualizati = response.visualization) === null || _response$visualizati === void 0 ? void 0 : _response$visualizati.length,\n        backendRequestId: response.request_id,\n        backendDuration: response.duration\n      });\n\n      // 更新聊天历史\n      setChatHistory([...newChatHistory, {\n        role: 'assistant',\n        content: response.response\n      }]);\n\n      // 逐步显示可视化过程\n      const visualizationSteps = response.visualization || [];\n      logger.info(`[${requestId}] 开始可视化处理`, {\n        visualizationStepsCount: visualizationSteps.length,\n        animationDelay: 300\n      });\n      for (let stepIndex = 0; stepIndex < visualizationSteps.length; stepIndex++) {\n        const step = visualizationSteps[stepIndex];\n        const tokens = parseVisualizationState(step);\n\n        // 更新消息中的tokens\n        setMessages(prev => prev.map(msg => {\n          if (msg.id === botMessage.id) {\n            return {\n              ...msg,\n              tokens\n            };\n          }\n          return msg;\n        }));\n\n        // 如果不是最后一步，等待一段时间再显示下一步\n        if (stepIndex < visualizationSteps.length - 1) {\n          await new Promise(resolve => setTimeout(resolve, 300)); // 增加延迟以便观察转换效果\n        }\n      }\n\n      // 生成完成，设置最终文本\n      setMessages(prev => {\n        const updatedMessages = prev.map(msg => {\n          if (msg.id === botMessage.id) {\n            return {\n              ...msg,\n              text: response.response,\n              isGenerated: true\n            };\n          }\n          return msg;\n        });\n\n        // 更新当前对话\n        updateCurrentConversation(updatedMessages);\n        return updatedMessages;\n      });\n      setConfidence(response.confidence || 0);\n      const requestEndTime = Date.now();\n      const totalDuration = requestEndTime - requestStartTime;\n      logger.info(`[${requestId}] 请求处理完成`, {\n        totalDuration: `${totalDuration}ms`,\n        finalResponseLength: response.response.length,\n        conversationUpdated: true\n      });\n    } catch (error) {\n      const requestEndTime = Date.now();\n      const totalDuration = requestEndTime - requestStartTime;\n      logger.error(`[${requestId}] 发送消息失败`, {\n        errorMessage: error.message,\n        errorType: error.name,\n        errorStack: error.stack,\n        totalDuration: `${totalDuration}ms`,\n        userInput: userInput,\n        settings: settings,\n        conversationId: currentConversationId\n      });\n      const errorMessage = {\n        id: Date.now() + 2,\n        text: '发送消息时出错: ' + (error.message || '未知错误'),\n        sender: 'bot',\n        timestamp: new Date()\n      };\n      setMessages(prevMessages => prevMessages.slice(0, -1).concat([errorMessage]));\n      setServerError(error.message || '服务器连接失败');\n    } finally {\n      setIsWaitingForResponse(false);\n      setIsGenerating(false);\n      logger.debug(`[${requestId}] 请求状态重置完成`);\n    }\n  };\n  const handleRegenerateResponse = async () => {\n    setIsGenerating(true);\n    setServerError(null);\n    try {\n      // 获取最后一条消息作为重发的基础\n      const lastUserMessage = messages.slice().reverse().find(msg => msg.sender === 'user');\n      if (!lastUserMessage) {\n        throw new Error('未找到可重发的消息');\n      }\n\n      // 添加用户消息\n      const userMsg = {\n        id: Date.now(),\n        text: lastUserMessage.text,\n        sender: 'user',\n        timestamp: new Date(),\n        isGenerated: true\n      };\n      setMessages(prev => [...prev, userMsg]);\n\n      // 准备聊天历史\n      const newChatHistory = [...chatHistory, {\n        role: 'user',\n        content: lastUserMessage.text\n      }];\n\n      // 创建初始的掩码消息\n      const initialTokens = Array(settings.gen_length).fill(null).map((_, index) => ({\n        id: index,\n        char: '[MASK]',\n        confidence: 0,\n        color: '#444444',\n        isGenerated: false\n      }));\n      const botMessage = {\n        id: Date.now() + 1,\n        text: '',\n        sender: 'bot',\n        timestamp: new Date(),\n        tokens: initialTokens,\n        isGenerated: false\n      };\n      setMessages(prev => [...prev, botMessage]);\n\n      // 调用后端API生成响应\n      const requestSettings = {\n        ...settings,\n        constraints: constraints\n      };\n      const response = await sendMessage(newChatHistory, requestSettings);\n      if (response.error) {\n        throw new Error(response.error);\n      }\n\n      // 更新聊天历史\n      setChatHistory([...newChatHistory, {\n        role: 'assistant',\n        content: response.response\n      }]);\n\n      // 逐步显示可视化过程\n      const visualizationSteps = response.visualization || [];\n      for (let stepIndex = 0; stepIndex < visualizationSteps.length; stepIndex++) {\n        const step = visualizationSteps[stepIndex];\n        const tokens = parseVisualizationState(step);\n\n        // 更新消息中的tokens\n        setMessages(prev => prev.map(msg => {\n          if (msg.id === botMessage.id) {\n            return {\n              ...msg,\n              tokens\n            };\n          }\n          return msg;\n        }));\n\n        // 如果不是最后一步，等待一段时间再显示下一步\n        if (stepIndex < visualizationSteps.length - 1) {\n          await new Promise(resolve => setTimeout(resolve, 300));\n        }\n      }\n\n      // 生成完成，设置最终文本\n      setMessages(prev => {\n        const updatedMessages = prev.map(msg => {\n          if (msg.id === botMessage.id) {\n            return {\n              ...msg,\n              text: response.response,\n              isGenerated: true\n            };\n          }\n          return msg;\n        });\n\n        // 更新当前对话\n        updateCurrentConversation(updatedMessages);\n        return updatedMessages;\n      });\n      setConfidence(response.confidence || 0);\n    } catch (error) {\n      console.error('重发消息时出错:', error);\n      const errorMessage = {\n        id: Date.now() + 2,\n        text: '重发消息时出错: ' + (error.message || '未知错误'),\n        sender: 'bot',\n        timestamp: new Date()\n      };\n      setMessages(prevMessages => prevMessages.slice(0, -1).concat([errorMessage]));\n      setServerError(error.message || '服务器连接失败');\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  // 辅助函数：更新当前对话\n  const updateCurrentConversation = (updatedMessages, finalChatHistory) => {\n    // 更新当前对话的历史\n    setConversations(prev => {\n      return prev.map(conv => {\n        if (conv.id === currentConversationId) {\n          return {\n            ...conv,\n            history: updatedMessages\n          };\n        }\n        return conv;\n      });\n    });\n  };\n\n  // 解析可视化状态\n  const parseVisualizationState = step => {\n    if (!step || !Array.isArray(step)) {\n      return [];\n    }\n    return step.map((tokenData, index) => {\n      // tokenData是 [token_text, color] 的格式\n      const [tokenText, color] = tokenData;\n      return {\n        id: index,\n        char: tokenText,\n        confidence: getConfidenceFromColor(color),\n        color: color,\n        isGenerated: tokenText !== '[MASK]'\n      };\n    });\n  };\n\n  // 从颜色推断置信度（与app.py保持一致）\n  const getConfidenceFromColor = color => {\n    switch (color) {\n      case '#444444':\n        return 0;\n      // [MASK] - 深灰色\n      case '#FF6666':\n        return 0.2;\n      // 低置信度 - 红色\n      case '#FFAA33':\n        return 0.5;\n      // 中置信度 - 橙色\n      case '#66CC66':\n        return 0.8;\n      // 高置信度 - 绿色\n      case '#6699CC':\n        return 1.0;\n      // 之前生成的token - 蓝色\n      default:\n        return 0.5;\n    }\n  };\n\n  // 获取置信度颜色（与app.py保持一致）\n  const getColorFromConfidence = confidence => {\n    if (confidence < 0.3) return '#FF6666'; // 低置信度：红色\n    if (confidence < 0.7) return '#FFAA33'; // 中置信度：橙色\n    return '#66CC66'; // 高置信度：绿色\n  };\n\n  // 处理按键按下事件\n  const handleKeyPress = e => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  };\n\n  // 检查服务器状态\n  useEffect(() => {\n    const checkStatus = async () => {\n      try {\n        const status = await getStatus();\n        setServerError(null);\n        setSystemStatus({\n          backendConnected: true,\n          device: status.device || 'Unknown',\n          modelLoaded: true,\n          lastCheck: new Date()\n        });\n      } catch (error) {\n        setServerError('服务器连接失败');\n        setSystemStatus({\n          backendConnected: false,\n          device: 'Unknown',\n          modelLoaded: false,\n          lastCheck: new Date()\n        });\n      }\n    };\n    checkStatus();\n    const interval = setInterval(checkStatus, 30000); // 每30秒检查一次\n\n    return () => clearInterval(interval);\n  }, []);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"diffusion-model\",\n    children: [/*#__PURE__*/_jsxDEV(Sidebar, {\n      conversations: conversations,\n      activeConversationId: currentConversationId,\n      onNewConversation: handleNewConversation,\n      onSelectConversation: handleSwitchConversation,\n      onDeleteConversation: handleDeleteConversation,\n      systemStatus: systemStatus,\n      isGenerating: isGenerating\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 622,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"main-content\",\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat-container\",\n        children: [/*#__PURE__*/_jsxDEV(MessageList, {\n          messages: messages,\n          isGenerating: isGenerating,\n          serverError: serverError,\n          getConfidenceColor: getColorFromConfidence,\n          formatTime: timestamp => new Date(timestamp).toLocaleTimeString(),\n          messagesEndRef: messagesEndRef\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 633,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"input-area-container\",\n          children: /*#__PURE__*/_jsxDEV(InputArea, {\n            inputValue: input,\n            setInputValue: setInput,\n            constraints: constraints,\n            setConstraints: setConstraints,\n            handleSend: handleSend,\n            handleKeyPress: handleKeyPress,\n            isGenerating: isGenerating\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 642,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 641,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 632,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 631,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"settings-sidebar\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"settings-section\",\n        children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n          children: \"\\u6A21\\u578B\\u8BBE\\u7F6E\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 658,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(SettingsPanel, {\n          settings: settings,\n          setSettings: setSettings,\n          isGenerating: isGenerating\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 659,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 657,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"confidence-section\",\n        children: /*#__PURE__*/_jsxDEV(ConfidenceIndicator, {}, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 667,\n          columnNumber: 21\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 666,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 656,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 621,\n    columnNumber: 9\n  }, this);\n};\n_s(DiffusionModel, \"CTgJ1xEWPqfH7rj7opuutunGzaY=\");\n_c = DiffusionModel;\nexport default DiffusionModel;\nvar _c;\n$RefreshReg$(_c, \"DiffusionModel\");","map":{"version":3,"names":["React","useState","useEffect","useRef","sendMessage","getStatus","generateText","checkServerStatus","logger","ConfidenceIndicator","MessageList","SettingsPanel","InputArea","Sidebar","jsxDEV","_jsxDEV","DiffusionModel","_s","messages","setMessages","input","setInput","isGenerating","setIsGenerating","chatHistory","setChatHistory","constraints","setConstraints","serverError","setServerError","confidence","setConfidence","isWaitingForResponse","setIsWaitingForResponse","settings","setSettings","temperature","top_p","gen_length","num_beams","steps","cfg_scale","conversations","setConversations","id","name","history","currentConversationId","setCurrentConversationId","systemStatus","setSystemStatus","backendConnected","device","modelLoaded","lastCheck","messagesEndRef","_messagesEndRef$curre","current","scrollIntoView","behavior","handleNewConversation","updatedConversations","map","conv","newConversationId","Date","now","newConversation","length","handleSwitchConversation","newCurrentConversation","find","handleDeleteConversation","filter","firstConv","newId","newConv","generateResponse","userMessage","userMsg","text","sender","timestamp","isGenerated","prev","newChatHistory","role","content","initialTokens","Array","fill","_","index","char","color","botMessage","tokens","requestSettings","response","error","Error","visualizationSteps","visualization","stepIndex","step","parseVisualizationState","msg","Promise","resolve","setTimeout","updatedMessages","finalChatHistory","updateCurrentConversation","console","message","handleSend","trim","requestStartTime","requestId","Math","random","toString","substr","info","userInput","inputLength","conversationId","currentMessagesCount","prevMessages","_response$response","_response$visualizati","chatHistoryLength","lastUserMessage","settingsUsed","endpoint","messageCount","responseLength","visualizationStepsCount","backendRequestId","request_id","backendDuration","duration","animationDelay","requestEndTime","totalDuration","finalResponseLength","conversationUpdated","errorMessage","errorType","errorStack","stack","slice","concat","debug","handleRegenerateResponse","reverse","isArray","tokenData","tokenText","getConfidenceFromColor","getColorFromConfidence","handleKeyPress","e","key","shiftKey","preventDefault","checkStatus","status","interval","setInterval","clearInterval","className","children","activeConversationId","onNewConversation","onSelectConversation","onDeleteConversation","fileName","_jsxFileName","lineNumber","columnNumber","getConfidenceColor","formatTime","toLocaleTimeString","inputValue","setInputValue","_c","$RefreshReg$"],"sources":["/root/LLaDA-main/lldm/src/DiffusionModel.js"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\nimport { sendMessage, getStatus, generateText, checkServerStatus, logger } from './services/apiService';\nimport ConfidenceIndicator from './components/ConfidenceIndicator';\nimport MessageList from './components/MessageList';\nimport SettingsPanel from './components/SettingsPanel';\nimport InputArea from './components/InputArea';\nimport Sidebar from './components/Sidebar';\nimport './styles/Sidebar.css';\nimport './styles/DiffusionModel.css';\n\nconst DiffusionModel = () => {\n    const [messages, setMessages] = useState([]);\n    const [input, setInput] = useState('');\n    const [isGenerating, setIsGenerating] = useState(false);\n    const [chatHistory, setChatHistory] = useState([]);\n    const [constraints, setConstraints] = useState('');\n    const [serverError, setServerError] = useState(null);\n    const [confidence, setConfidence] = useState(0);\n    const [isWaitingForResponse, setIsWaitingForResponse] = useState(false);\n    const [settings, setSettings] = useState({\n        temperature: 0.0,\n        top_p: 0.95,\n        gen_length: 50,\n        num_beams: 4,\n        steps: 32,\n        cfg_scale: 1.0\n    });\n\n    // --- Conversation Management State ---\n    const [conversations, setConversations] = useState([\n        { id: 0, name: '对话 1', history: [] }\n    ]);\n    const [currentConversationId, setCurrentConversationId] = useState(0);\n    const [systemStatus, setSystemStatus] = useState({\n        backendConnected: false,\n        device: 'Unknown',\n        modelLoaded: false,\n        lastCheck: null\n    });\n\n    const messagesEndRef = useRef(null);\n\n    useEffect(() => {\n        messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n    }, [messages]);\n\n    // --- Conversation Management Handlers ---\n\n    const handleNewConversation = () => {\n        // Save the current conversation's history first.\n        const updatedConversations = conversations.map(conv =>\n            conv.id === currentConversationId ? { ...conv, history: messages } : conv\n        );\n\n        // Create the new conversation.\n        const newConversationId = Date.now(); // Use timestamp for unique ID\n        const newConversation = {\n            id: newConversationId,\n            name: `对话 ${updatedConversations.length + 1}`,\n            history: []\n        };\n\n        setConversations([...updatedConversations, newConversation]);\n        setCurrentConversationId(newConversationId);\n        setMessages([]); // Clear messages for the new conversation\n        setInput('');\n        setConfidence(0);\n        setIsWaitingForResponse(false);\n    };\n\n    const handleSwitchConversation = (id) => {\n        if (id === currentConversationId) return;\n\n        // Save the current conversation's history before switching.\n        const updatedConversations = conversations.map(conv =>\n            conv.id === currentConversationId ? { ...conv, history: messages } : conv\n        );\n\n        const newCurrentConversation = updatedConversations.find(conv => conv.id === id);\n\n        if (newCurrentConversation) {\n            setConversations(updatedConversations);\n            setCurrentConversationId(newCurrentConversation.id);\n            setMessages(newCurrentConversation.history || []);\n        }\n    };\n\n    const handleDeleteConversation = (id) => {\n        const updatedConversations = conversations.filter(conv => conv.id !== id);\n        setConversations(updatedConversations);\n\n        if (id === currentConversationId) {\n            if (updatedConversations.length > 0) {\n                const firstConv = updatedConversations[0];\n                setCurrentConversationId(firstConv.id);\n                setMessages(firstConv.history || []);\n            } else {\n                // If all conversations are deleted, create a new default one.\n                const newId = Date.now();\n                const newConv = { id: newId, name: '对话 1', history: [] };\n                setConversations([newConv]);\n                setCurrentConversationId(newId);\n                setMessages([]);\n            }\n        }\n    };\n\n\n    // 生成完整的回复\n    const generateResponse = async (userMessage) => {\n        setIsGenerating(true);\n        setServerError(null);\n        \n        try {\n            // 添加用户消息\n            const userMsg = {\n                id: Date.now(),\n                text: userMessage,\n                sender: 'user',\n                timestamp: new Date(),\n                isGenerated: true\n            };\n            \n            setMessages(prev => [...prev, userMsg]);\n\n            // 准备聊天历史\n            const newChatHistory = [\n                ...chatHistory,\n                { role: 'user', content: userMessage }\n            ];\n\n            // 创建初始的掩码消息\n            const initialTokens = Array(settings.gen_length).fill(null).map((_, index) => ({\n                id: index,\n                char: '[MASK]',\n                confidence: 0,\n                color: '#444444',\n                isGenerated: false\n            }));\n\n            const botMessage = {\n                id: Date.now() + 1,\n                text: '',\n                sender: 'bot',\n                timestamp: new Date(),\n                tokens: initialTokens,\n                isGenerated: false\n            };\n\n            setMessages(prev => [...prev, botMessage]);\n\n            // 调用后端API生成响应\n            const requestSettings = {\n                ...settings,\n                constraints: constraints\n            };\n\n            const response = await sendMessage(newChatHistory, requestSettings);\n            \n            if (response.error) {\n                throw new Error(response.error);\n            }\n\n            // 更新聊天历史\n            setChatHistory([\n                ...newChatHistory,\n                { role: 'assistant', content: response.response }\n            ]);\n\n            // 逐步显示可视化过程\n            const visualizationSteps = response.visualization || [];\n            \n            for (let stepIndex = 0; stepIndex < visualizationSteps.length; stepIndex++) {\n                const step = visualizationSteps[stepIndex];\n                const tokens = parseVisualizationState(step);\n                \n                // 更新消息中的tokens\n                setMessages(prev => prev.map(msg => {\n                    if (msg.id === botMessage.id) {\n                        return { ...msg, tokens };\n                    }\n                    return msg;\n                }));\n                \n                // 如果不是最后一步，等待一段时间再显示下一步\n                if (stepIndex < visualizationSteps.length - 1) {\n                    await new Promise(resolve => setTimeout(resolve, 300));\n                }\n            }\n\n            // 生成完成，设置最终文本\n            setMessages(prev => {\n                const updatedMessages = prev.map(msg => {\n                    if (msg.id === botMessage.id) {\n                        return { \n                            ...msg, \n                            text: response.response,\n                            isGenerated: true \n                        };\n                    }\n                    return msg;\n                });\n                \n                // 更新当前对话\n                const finalChatHistory = [\n                    ...newChatHistory,\n                    { role: 'assistant', content: response.response }\n                ];\n                setChatHistory(finalChatHistory);\n                updateCurrentConversation(updatedMessages, finalChatHistory);\n                \n                return updatedMessages;\n            });\n\n        } catch (error) {\n            console.error('生成响应时出错:', error);\n            setServerError(error.message || '服务器连接失败');\n            \n            // 移除未完成的bot消息\n            setMessages(prev => prev.filter(msg => msg.id !== Date.now() + 1));\n        } finally {\n            setIsGenerating(false);\n        }\n    };\n\n    const handleSend = async () => {\n        if (input.trim() === '' || isWaitingForResponse) return;\n        \n        const requestStartTime = Date.now();\n        const requestId = `frontend_${requestStartTime}_${Math.random().toString(36).substr(2, 9)}`;\n        \n        logger.info(`[${requestId}] 开始处理用户发送请求`, {\n            userInput: input,\n            inputLength: input.length,\n            conversationId: currentConversationId,\n            currentMessagesCount: messages.length,\n            settings: settings,\n            constraints: constraints\n        });\n        \n        const userMessage = { \n            id: Date.now(),\n            text: input, \n            sender: 'user',\n            timestamp: new Date()\n        };\n        setMessages(prevMessages => [...prevMessages, userMessage]);\n        const userInput = input;\n        setInput('');\n        setIsWaitingForResponse(true);\n        setIsGenerating(true);\n        setServerError(null);\n\n        try {\n            // 准备聊天历史\n            const newChatHistory = [\n                ...chatHistory,\n                { role: 'user', content: userInput }\n            ];\n\n            logger.info(`[${requestId}] 准备发送到后端`, {\n                chatHistoryLength: newChatHistory.length,\n                lastUserMessage: userInput,\n                settingsUsed: settings\n            });\n\n            // 创建初始的掩码消息\n            const initialTokens = Array(settings.gen_length).fill(null).map((_, index) => ({\n                id: index,\n                char: '[MASK]',\n                confidence: 0,\n                color: '#444444',\n                isGenerated: false\n            }));\n\n            const botMessage = {\n                id: Date.now() + 1,\n                text: '',\n                sender: 'bot',\n                timestamp: new Date(),\n                tokens: initialTokens,\n                isGenerated: false\n            };\n\n            setMessages(prevMessages => [...prevMessages, botMessage]);\n\n            // 调用后端API生成响应\n            const requestSettings = {\n                ...settings,\n                constraints: constraints\n            };\n\n            logger.info(`[${requestId}] 发送API请求`, {\n                endpoint: '/generate',\n                messageCount: newChatHistory.length,\n                settings: requestSettings\n            });\n\n            const response = await sendMessage(newChatHistory, requestSettings);\n            \n            if (response.error) {\n                throw new Error(response.error);\n            }\n\n            logger.info(`[${requestId}] 收到后端响应`, {\n                responseLength: response.response?.length,\n                visualizationStepsCount: response.visualization?.length,\n                backendRequestId: response.request_id,\n                backendDuration: response.duration\n            });\n\n            // 更新聊天历史\n            setChatHistory([\n                ...newChatHistory,\n                { role: 'assistant', content: response.response }\n            ]);\n\n            // 逐步显示可视化过程\n            const visualizationSteps = response.visualization || [];\n            \n            logger.info(`[${requestId}] 开始可视化处理`, {\n                visualizationStepsCount: visualizationSteps.length,\n                animationDelay: 300\n            });\n            \n            for (let stepIndex = 0; stepIndex < visualizationSteps.length; stepIndex++) {\n                const step = visualizationSteps[stepIndex];\n                const tokens = parseVisualizationState(step);\n                \n                // 更新消息中的tokens\n                setMessages(prev => prev.map(msg => {\n                    if (msg.id === botMessage.id) {\n                        return { ...msg, tokens };\n                    }\n                    return msg;\n                }));\n                \n                // 如果不是最后一步，等待一段时间再显示下一步\n                if (stepIndex < visualizationSteps.length - 1) {\n                    await new Promise(resolve => setTimeout(resolve, 300)); // 增加延迟以便观察转换效果\n                }\n            }\n\n            // 生成完成，设置最终文本\n            setMessages(prev => {\n                const updatedMessages = prev.map(msg => {\n                    if (msg.id === botMessage.id) {\n                        return { \n                            ...msg, \n                            text: response.response,\n                            isGenerated: true \n                        };\n                    }\n                    return msg;\n                });\n                \n                // 更新当前对话\n                updateCurrentConversation(updatedMessages);\n                \n                return updatedMessages;\n            });\n\n            setConfidence(response.confidence || 0);\n            \n            const requestEndTime = Date.now();\n            const totalDuration = requestEndTime - requestStartTime;\n            \n            logger.info(`[${requestId}] 请求处理完成`, {\n                totalDuration: `${totalDuration}ms`,\n                finalResponseLength: response.response.length,\n                conversationUpdated: true\n            });\n            \n        } catch (error) {\n            const requestEndTime = Date.now();\n            const totalDuration = requestEndTime - requestStartTime;\n            \n            logger.error(`[${requestId}] 发送消息失败`, {\n                errorMessage: error.message,\n                errorType: error.name,\n                errorStack: error.stack,\n                totalDuration: `${totalDuration}ms`,\n                userInput: userInput,\n                settings: settings,\n                conversationId: currentConversationId\n            });\n            \n            const errorMessage = { \n                id: Date.now() + 2,\n                text: '发送消息时出错: ' + (error.message || '未知错误'), \n                sender: 'bot',\n                timestamp: new Date()\n            };\n            setMessages(prevMessages => prevMessages.slice(0, -1).concat([errorMessage]));\n            setServerError(error.message || '服务器连接失败');\n        } finally {\n            setIsWaitingForResponse(false);\n            setIsGenerating(false);\n            \n            logger.debug(`[${requestId}] 请求状态重置完成`);\n        }\n    };\n\n    const handleRegenerateResponse = async () => {\n        setIsGenerating(true);\n        setServerError(null);\n        \n        try {\n            // 获取最后一条消息作为重发的基础\n            const lastUserMessage = messages\n                .slice()\n                .reverse()\n                .find(msg => msg.sender === 'user');\n\n            if (!lastUserMessage) {\n                throw new Error('未找到可重发的消息');\n            }\n\n            // 添加用户消息\n            const userMsg = {\n                id: Date.now(),\n                text: lastUserMessage.text,\n                sender: 'user',\n                timestamp: new Date(),\n                isGenerated: true\n            };\n            \n            setMessages(prev => [...prev, userMsg]);\n\n            // 准备聊天历史\n            const newChatHistory = [\n                ...chatHistory,\n                { role: 'user', content: lastUserMessage.text }\n            ];\n\n            // 创建初始的掩码消息\n            const initialTokens = Array(settings.gen_length).fill(null).map((_, index) => ({\n                id: index,\n                char: '[MASK]',\n                confidence: 0,\n                color: '#444444',\n                isGenerated: false\n            }));\n\n            const botMessage = {\n                id: Date.now() + 1,\n                text: '',\n                sender: 'bot',\n                timestamp: new Date(),\n                tokens: initialTokens,\n                isGenerated: false\n            };\n\n            setMessages(prev => [...prev, botMessage]);\n\n            // 调用后端API生成响应\n            const requestSettings = {\n                ...settings,\n                constraints: constraints\n            };\n\n            const response = await sendMessage(newChatHistory, requestSettings);\n            \n            if (response.error) {\n                throw new Error(response.error);\n            }\n\n            // 更新聊天历史\n            setChatHistory([\n                ...newChatHistory,\n                { role: 'assistant', content: response.response }\n            ]);\n\n            // 逐步显示可视化过程\n            const visualizationSteps = response.visualization || [];\n            \n            for (let stepIndex = 0; stepIndex < visualizationSteps.length; stepIndex++) {\n                const step = visualizationSteps[stepIndex];\n                const tokens = parseVisualizationState(step);\n                \n                // 更新消息中的tokens\n                setMessages(prev => prev.map(msg => {\n                    if (msg.id === botMessage.id) {\n                        return { ...msg, tokens };\n                    }\n                    return msg;\n                }));\n                \n                // 如果不是最后一步，等待一段时间再显示下一步\n                if (stepIndex < visualizationSteps.length - 1) {\n                    await new Promise(resolve => setTimeout(resolve, 300));\n                }\n            }\n\n            // 生成完成，设置最终文本\n            setMessages(prev => {\n                const updatedMessages = prev.map(msg => {\n                    if (msg.id === botMessage.id) {\n                        return { \n                            ...msg, \n                            text: response.response,\n                            isGenerated: true \n                        };\n                    }\n                    return msg;\n                });\n                \n                // 更新当前对话\n                updateCurrentConversation(updatedMessages);\n                \n                return updatedMessages;\n            });\n\n            setConfidence(response.confidence || 0);\n            \n        } catch (error) {\n            console.error('重发消息时出错:', error);\n            const errorMessage = { \n                id: Date.now() + 2,\n                text: '重发消息时出错: ' + (error.message || '未知错误'), \n                sender: 'bot',\n                timestamp: new Date()\n            };\n            setMessages(prevMessages => prevMessages.slice(0, -1).concat([errorMessage]));\n            setServerError(error.message || '服务器连接失败');\n        } finally {\n            setIsGenerating(false);\n        }\n    };\n\n    // 辅助函数：更新当前对话\n    const updateCurrentConversation = (updatedMessages, finalChatHistory) => {\n        // 更新当前对话的历史\n        setConversations(prev => {\n            return prev.map(conv => {\n                if (conv.id === currentConversationId) {\n                    return { ...conv, history: updatedMessages };\n                }\n                return conv;\n            });\n        });\n    };\n\n    // 解析可视化状态\n    const parseVisualizationState = (step) => {\n        if (!step || !Array.isArray(step)) {\n            return [];\n        }\n\n        return step.map((tokenData, index) => {\n            // tokenData是 [token_text, color] 的格式\n            const [tokenText, color] = tokenData;\n            \n            return {\n                id: index,\n                char: tokenText,\n                confidence: getConfidenceFromColor(color),\n                color: color,\n                isGenerated: tokenText !== '[MASK]'\n            };\n        });\n    };\n\n    // 从颜色推断置信度（与app.py保持一致）\n    const getConfidenceFromColor = (color) => {\n        switch (color) {\n            case '#444444': return 0;     // [MASK] - 深灰色\n            case '#FF6666': return 0.2;   // 低置信度 - 红色\n            case '#FFAA33': return 0.5;   // 中置信度 - 橙色\n            case '#66CC66': return 0.8;   // 高置信度 - 绿色\n            case '#6699CC': return 1.0;   // 之前生成的token - 蓝色\n            default: return 0.5;\n        }\n    };\n\n    // 获取置信度颜色（与app.py保持一致）\n    const getColorFromConfidence = (confidence) => {\n        if (confidence < 0.3) return '#FF6666'; // 低置信度：红色\n        if (confidence < 0.7) return '#FFAA33'; // 中置信度：橙色\n        return '#66CC66';                       // 高置信度：绿色\n    };\n\n    // 处理按键按下事件\n    const handleKeyPress = (e) => {\n        if (e.key === 'Enter' && !e.shiftKey) {\n            e.preventDefault();\n            handleSend();\n        }\n    };\n\n    // 检查服务器状态\n    useEffect(() => {\n        const checkStatus = async () => {\n            try {\n                const status = await getStatus();\n                setServerError(null);\n                setSystemStatus({\n                    backendConnected: true,\n                    device: status.device || 'Unknown',\n                    modelLoaded: true,\n                    lastCheck: new Date()\n                });\n            } catch (error) {\n                setServerError('服务器连接失败');\n                setSystemStatus({\n                    backendConnected: false,\n                    device: 'Unknown',\n                    modelLoaded: false,\n                    lastCheck: new Date()\n                });\n            }\n        };\n\n        checkStatus();\n        const interval = setInterval(checkStatus, 30000); // 每30秒检查一次\n\n        return () => clearInterval(interval);\n    }, []);\n\n    return (\n        <div className=\"diffusion-model\">\n            <Sidebar\n                conversations={conversations}\n                activeConversationId={currentConversationId}\n                onNewConversation={handleNewConversation}\n                onSelectConversation={handleSwitchConversation}\n                onDeleteConversation={handleDeleteConversation}\n                systemStatus={systemStatus}\n                isGenerating={isGenerating}\n            />\n            <div className=\"main-content\">\n                <div className=\"chat-container\">\n                    <MessageList \n                        messages={messages} \n                        isGenerating={isGenerating}\n                        serverError={serverError}\n                        getConfidenceColor={getColorFromConfidence}\n                        formatTime={(timestamp) => new Date(timestamp).toLocaleTimeString()}\n                        messagesEndRef={messagesEndRef}\n                    />\n                    <div className=\"input-area-container\">\n                        <InputArea \n                            inputValue={input}\n                            setInputValue={setInput}\n                            constraints={constraints}\n                            setConstraints={setConstraints}\n                            handleSend={handleSend}\n                            handleKeyPress={handleKeyPress}\n                            isGenerating={isGenerating}\n                        />\n                    </div>\n                </div>\n            </div>\n            \n            {/* 右侧设置边栏 - 模型设置和置信度颜色说明 */}\n            <div className=\"settings-sidebar\">\n                <div className=\"settings-section\">\n                    <h3>模型设置</h3>\n                    <SettingsPanel \n                        settings={settings}\n                        setSettings={setSettings}\n                        isGenerating={isGenerating}\n                    />\n                </div>\n                \n                <div className=\"confidence-section\">\n                    <ConfidenceIndicator />\n                </div>\n            </div>\n        </div>\n    );\n};\n\nexport default DiffusionModel;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}